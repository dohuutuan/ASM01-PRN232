@page
@model _FE.Pages.NewsPublicModel
@{
    ViewData["Title"] = "News Articles";
}

<div class="container my-5">
    <div class="card shadow-sm border-0 rounded-4 p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold text-primary mb-0">📰 News Articles</h2>
        </div>

        <div class="filter-bar mb-4 p-3 rounded-3 bg-light d-flex flex-wrap gap-2 align-items-center shadow-sm">
            <input type="text" id="searchTitle" placeholder="Search by Title" class="form-control flex-grow-1" style="max-width: 220px;">
            <input type="text" id="searchAuthor" placeholder="Search by Author" class="form-control flex-grow-1" style="max-width: 220px;">
            <select id="filterCategory" class="form-select flex-grow-1" style="max-width: 220px;">
                <option value="">All Categories</option>
            </select>
            <button class="btn btn-primary" onclick="loadNews(1)">
                <i class="bi bi-search me-1"></i> Search
            </button>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-primary">
                    <tr>
                        <th>Title</th>
                        <th>Category</th>
                        <th>Tags</th>
                        <th>Author</th>
                        <th>Created Date</th>
                    </tr>
                </thead>
                <tbody id="newsTableBody"></tbody>
            </table>
        </div>

        <nav class="d-flex justify-content-center mt-4">
            <ul class="pagination mb-0">
                <li class="page-item">
                    <a class="page-link" href="#" id="prevPage"><i class="bi bi-chevron-left"></i> Prev</a>
                </li>
                <li class="page-item disabled">
                    <span class="page-link" id="pageInfo">1 / 1</span>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#" id="nextPage">Next <i class="bi bi-chevron-right"></i></a>
                </li>
            </ul>
        </nav>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.js"></script>

    <script>
        let tagList = [];
        let categoryList = [];
        let currentPage = 1;
        const pageSize = 3;

        function loadCategories() {
            return $.ajax({
                url: 'http://localhost:5053/api/Category',
                type: 'GET',
                success: function (res) {
                    categoryList = res.data || [];
                    const filterCategory = $('#filterCategory');
                    filterCategory.empty().append('<option value="">All Categories</option>');
                    categoryList.forEach(c => {
                        filterCategory.append(`<option value="${c.categoryId}">${c.categoryName}</option>`);
                    });
                }
            });
        }

        function loadTags() {
            return $.ajax({
                url: 'http://localhost:5053/api/Tag',
                type: 'GET',
                success: function (res) {
                    tagList = res.data || [];
                }
            });
        }

        function buildODataQuery(pageNumber) {
            const title = $('#searchTitle').val();
            const author = $('#searchAuthor').val();
            const category = $('#filterCategory').val();
            let filters = [];

            if (title) filters.push(`contains(NewsTitle,'${title}')`);
            if (author) filters.push(`contains(CreatedByName,'${author}')`);
            if (category) filters.push(`CategoryId eq ${category}`);

            const skip = (pageNumber - 1) * pageSize;
            const filterStr = filters.length > 0 ? `$filter=${filters.join(' and ')}` : '';
            return `?$orderby=CreatedDate desc&$top=${pageSize}&$skip=${skip}` + (filterStr ? `&${filterStr}` : '');
        }

        function loadNews(pageNumber) {
            currentPage = pageNumber;
            const query = buildODataQuery(pageNumber) + "&$count=false";

            $.ajax({
                url: 'http://localhost:5053/api/News/Public' + query,
                type: 'GET',
                success: function (res) {
                    const newsList = res.value || res;
                    renderTable(newsList);
                    $('#pageInfo').text(`Page ${currentPage}`);
                },
                error: function () {
                    $('#newsTableBody').html('<tr><td colspan="5" class="text-center text-danger">Cannot load news</td></tr>');
                }
            });
        }

        function renderTable(list) {
            const tbody = $('#newsTableBody');
            tbody.empty();
            if (!list.length) {
                tbody.append('<tr><td colspan="5" class="text-center text-muted">No news found</td></tr>');
                return;
            }

            list.forEach(n => {
                const categoryName = n.categoryName || '';
                const tags = n.tagIds?.map(tid => tagList.find(t => t.tagId === tid)?.tagName).filter(Boolean).join(', ') || '';
                const row = `
                    <tr>
                        <td><a href="/News/NewsDetail/${n.newsArticleId}" class="text-decoration-none fw-semibold text-dark">${n.newsTitle}</a></td>
                        <td>${categoryName}</td>
                        <td>${tags}</td>
                        <td>${n.createdByName}</td>
                        <td>${new Date(n.createdDate).toLocaleDateString()}</td>
                    </tr>`;
                tbody.append(row);
            });
        }

        $(document).on('click', '#prevPage', function (e) {
            e.preventDefault();
            if (currentPage > 1) loadNews(currentPage - 1);
        });

        $(document).on('click', '#nextPage', function (e) {
            e.preventDefault();
            loadNews(currentPage + 1);
        });

        $(document).ready(function () {
            $.when(loadCategories(), loadTags()).done(() => loadNews(1));
        });
    </script>
}

<style>
    body {
        background-color: #f8fafc;
    }

    .filter-bar input,
    .filter-bar select {
        border-radius: 0.5rem;
        border: 1px solid #d0d7de;
        transition: all 0.2s ease;
    }

        .filter-bar input:focus,
        .filter-bar select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.15);
        }

    table thead {
        background: linear-gradient(90deg, #007bff, #6c63ff);
        color: white;
    }

    table tbody tr:hover {
        background-color: #f2f6ff;
        transition: 0.2s;
    }

    .pagination .page-link {
        border: none;
        color: #007bff;
        font-weight: 500;
    }

        .pagination .page-link:hover {
            background-color: #e7f1ff;
            border-radius: 8px;
        }

    .pagination .disabled .page-link {
        color: #999;
    }

    .card {
        background-color: #ffffff;
        border-radius: 1rem;
    }
</style>
